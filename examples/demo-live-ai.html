<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cognivo - Live AI Demo</title>
  <link rel="stylesheet" href="../packages/tokens/dist/index.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #09090b;
      --surface: #18181b;
      --surface-2: #27272a;
      --border: #3f3f46;
      --text: #fafafa;
      --text-muted: #a1a1aa;
      --accent: #8b5cf6;
      --accent-hover: #7c3aed;
      --accent-glow: rgba(139, 92, 246, 0.15);
      --success: #22c55e;
      --warning: #f59e0b;
      --danger: #ef4444;

      --cg-gray-white: var(--surface);
      --cg-gray-50: #27272a;
      --cg-gray-100: var(--border);
      --cg-gray-500: var(--text-muted);
      --cg-gray-600: #71717a;
      --cg-gray-700: #52525b;
      --cg-gray-900: var(--text);
      --cg-brand-ai-accent: var(--accent);
      --cg-brand-ai-highlight: #a78bfa;
      --cg-brand-ai-background: var(--accent-glow);
      --cg-brand-ai-border: rgba(139, 92, 246, 0.4);
      --cg-green-500: var(--success);
      --cg-yellow-500: var(--warning);
      --cg-red-500: var(--danger);
      --cg-blue-500: #3b82f6;
      --cg-brand-primary-400: var(--accent);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    html {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
    }

    body { min-height: 100vh; padding: 32px; }

    .container {
      max-width: 900px;
      margin: 0 auto;
    }

    .header {
      text-align: center;
      margin-bottom: 40px;
    }

    .header h1 {
      font-size: 32px;
      font-weight: 700;
      margin-bottom: 8px;
      background: linear-gradient(135deg, var(--accent), #a78bfa);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .header p {
      color: var(--text-muted);
      font-size: 16px;
    }

    .section {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 24px;
    }

    .section-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
    }

    .badge-success { background: rgba(34, 197, 94, 0.15); color: var(--success); }
    .badge-warning { background: rgba(245, 158, 11, 0.15); color: var(--warning); }
    .badge-accent { background: var(--accent-glow); color: var(--accent); }

    /* API Key Form */
    .api-form {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .api-input {
      flex: 1;
      padding: 12px 16px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-size: 14px;
      font-family: monospace;
    }

    .api-input:focus {
      outline: none;
      border-color: var(--accent);
    }

    .api-input::placeholder {
      color: var(--text-muted);
    }

    .btn {
      padding: 12px 20px;
      background: var(--accent);
      border: none;
      border-radius: 8px;
      color: white;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s;
    }

    .btn:hover {
      background: var(--accent-hover);
      transform: translateY(-1px);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .btn-outline {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text-muted);
    }

    .btn-outline:hover {
      background: var(--surface-2);
      color: var(--text);
    }

    /* Status */
    .status {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 16px;
      background: var(--bg);
      border-radius: 8px;
      font-size: 13px;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }

    .status-dot.connected { background: var(--success); }
    .status-dot.disconnected { background: var(--danger); }

    /* Data Grid */
    .data-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-bottom: 20px;
    }

    .data-item {
      padding: 16px;
      background: var(--bg);
      border-radius: 8px;
    }

    .data-item-label {
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    .data-item-value {
      font-size: 20px;
      font-weight: 700;
    }

    /* AI Actions */
    .ai-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 16px;
    }

    .ai-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 10px 16px;
      background: var(--accent-glow);
      border: 1px solid var(--accent);
      border-radius: 8px;
      color: var(--accent);
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s;
    }

    .ai-btn:hover:not(:disabled) {
      background: var(--accent);
      color: white;
    }

    .ai-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* AI Output */
    .ai-output {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      min-height: 150px;
    }

    .ai-output-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .ai-output-title {
      font-weight: 600;
      color: var(--accent);
    }

    .ai-output-content {
      line-height: 1.8;
    }

    .ai-output-content ul {
      margin: 12px 0;
      padding-left: 20px;
    }

    .ai-output-content li {
      margin: 8px 0;
    }

    .ai-loading {
      display: flex;
      align-items: center;
      gap: 12px;
      color: var(--text-muted);
    }

    /* Help text */
    .help-text {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 8px;
    }

    .help-text a {
      color: var(--accent);
    }

    /* Responsive */
    @media (max-width: 600px) {
      body { padding: 16px; }
      .data-grid { grid-template-columns: 1fr; }
      .api-form { flex-direction: column; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <h1>Cognivo Live AI Demo</h1>
      <p>Real-time AI insights powered by OpenAI GPT-4</p>
    </header>

    <!-- API Key Configuration -->
    <section class="section" id="config-section">
      <div class="section-title">
        API Configuration
        <span class="badge badge-warning" id="status-badge">Not Connected</span>
      </div>

      <div class="api-form">
        <input
          type="password"
          class="api-input"
          id="api-key-input"
          placeholder="Enter your OpenAI API key (sk-...)"
        >
        <button class="btn" id="connect-btn" onclick="connectApi()">Connect</button>
        <button class="btn btn-outline" id="clear-btn" onclick="clearApi()" style="display:none">Clear</button>
      </div>

      <p class="help-text">
        Your API key is stored locally in your browser and never sent to our servers.
        Get your key at <a href="https://platform.openai.com/api-keys" target="_blank">platform.openai.com</a>
      </p>
    </section>

    <!-- Sample Data -->
    <section class="section">
      <div class="section-title">Sample Business Data</div>

      <div class="data-grid">
        <div class="data-item">
          <div class="data-item-label">Monthly Revenue</div>
          <div class="data-item-value">$142,580</div>
        </div>
        <div class="data-item">
          <div class="data-item-label">Active Users</div>
          <div class="data-item-value">12,847</div>
        </div>
        <div class="data-item">
          <div class="data-item-label">Conversion Rate</div>
          <div class="data-item-value">4.28%</div>
        </div>
        <div class="data-item">
          <div class="data-item-label">Churn Rate</div>
          <div class="data-item-value">2.1%</div>
        </div>
        <div class="data-item">
          <div class="data-item-label">Avg Order Value</div>
          <div class="data-item-value">$85.40</div>
        </div>
        <div class="data-item">
          <div class="data-item-label">Customer LTV</div>
          <div class="data-item-value">$1,240</div>
        </div>
      </div>

      <div class="help-text">This sample data will be sent to GPT-4 for analysis</div>
    </section>

    <!-- AI Analysis -->
    <section class="section">
      <div class="section-title">
        AI Analysis
        <ai-confidence-badge id="confidence-badge" score="0" size="sm"></ai-confidence-badge>
      </div>

      <div class="ai-actions">
        <button class="ai-btn" onclick="runIntent('explain')" disabled id="btn-explain">
          <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/></svg>
          Explain Trends
        </button>
        <button class="ai-btn" onclick="runIntent('forecast')" disabled id="btn-forecast">
          <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/></svg>
          Forecast Growth
        </button>
        <button class="ai-btn" onclick="runIntent('optimize')" disabled id="btn-optimize">
          <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
          Optimize Strategy
        </button>
        <button class="ai-btn" onclick="runIntent('risks')" disabled id="btn-risks">
          <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
          Identify Risks
        </button>
      </div>

      <div class="ai-output" id="ai-output">
        <div class="ai-output-content" style="color: var(--text-muted); text-align: center; padding: 40px;">
          Connect your OpenAI API key above to enable AI analysis
        </div>
      </div>
    </section>
  </div>

  <script type="module">
    import '../packages/components/dist/index.js';

    // Sample business data to analyze
    const businessData = {
      revenue: {
        current: 142580,
        previous: 114720,
        trend: [82000, 91000, 86000, 105000, 118000, 142580]
      },
      users: {
        active: 12847,
        new: 847,
        churned: 234
      },
      metrics: {
        conversionRate: 4.28,
        churnRate: 2.1,
        avgOrderValue: 85.40,
        customerLTV: 1240
      },
      products: [
        { name: 'Pro Plan', revenue: 68420, users: 1247, growth: 32.4 },
        { name: 'Enterprise', revenue: 45200, users: 89, growth: 18.2 },
        { name: 'Starter', revenue: 18960, users: 2840, growth: 8.7 },
        { name: 'Legacy Basic', revenue: 10000, users: 524, growth: -12.3 }
      ]
    };

    // Prompts for each intent
    const intentPrompts = {
      explain: `Analyze this business data and explain the key trends and patterns you observe. Be specific about what's working well and what needs attention.`,
      forecast: `Based on this business data, provide a 3-month forecast for revenue and user growth. Include confidence levels and key assumptions.`,
      optimize: `Review this business data and provide specific, actionable recommendations to optimize growth and profitability. Prioritize by potential impact.`,
      risks: `Analyze this business data and identify potential risks, red flags, or areas of concern. Suggest mitigation strategies for each.`
    };

    let apiKey = localStorage.getItem('cognivo_openai_key') || '';

    // Check for existing API key on load
    if (apiKey) {
      document.getElementById('api-key-input').value = '••••••••••••••••';
      updateConnectionStatus(true);
    }

    // Connect API
    window.connectApi = function() {
      const input = document.getElementById('api-key-input');
      const key = input.value.trim();

      if (!key || key === '••••••••••••••••') {
        alert('Please enter a valid API key');
        return;
      }

      if (!key.startsWith('sk-')) {
        alert('Invalid API key format. Key should start with "sk-"');
        return;
      }

      apiKey = key;
      localStorage.setItem('cognivo_openai_key', key);
      input.value = '••••••••••••••••';
      updateConnectionStatus(true);
    };

    // Clear API
    window.clearApi = function() {
      apiKey = '';
      localStorage.removeItem('cognivo_openai_key');
      document.getElementById('api-key-input').value = '';
      updateConnectionStatus(false);
    };

    // Update UI based on connection status
    function updateConnectionStatus(connected) {
      const badge = document.getElementById('status-badge');
      const connectBtn = document.getElementById('connect-btn');
      const clearBtn = document.getElementById('clear-btn');
      const buttons = document.querySelectorAll('.ai-btn');

      if (connected) {
        badge.textContent = 'Connected';
        badge.className = 'badge badge-success';
        connectBtn.style.display = 'none';
        clearBtn.style.display = 'block';
        buttons.forEach(btn => btn.disabled = false);
      } else {
        badge.textContent = 'Not Connected';
        badge.className = 'badge badge-warning';
        connectBtn.style.display = 'block';
        clearBtn.style.display = 'none';
        buttons.forEach(btn => btn.disabled = true);
      }
    }

    // Run AI Intent
    window.runIntent = async function(intent) {
      if (!apiKey) {
        alert('Please connect your API key first');
        return;
      }

      const output = document.getElementById('ai-output');
      const confidenceBadge = document.getElementById('confidence-badge');
      const buttons = document.querySelectorAll('.ai-btn');

      // Disable buttons during request
      buttons.forEach(btn => btn.disabled = true);

      // Show loading
      output.innerHTML = `
        <div class="ai-loading">
          <ai-thinking-indicator size="md"></ai-thinking-indicator>
          <span>GPT-4 is analyzing your data...</span>
        </div>
      `;

      try {
        const response = await fetch('https://api.openai.com/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`
          },
          body: JSON.stringify({
            model: 'gpt-4o-mini',
            messages: [
              {
                role: 'system',
                content: `You are a business analytics AI assistant. Analyze data and provide clear, actionable insights. Format your response with bullet points where appropriate. Be specific and quantitative when possible.`
              },
              {
                role: 'user',
                content: `${intentPrompts[intent]}\n\nBusiness Data:\n${JSON.stringify(businessData, null, 2)}`
              }
            ],
            temperature: 0.3,
            max_tokens: 800
          })
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error?.message || 'API request failed');
        }

        const data = await response.json();
        const content = data.choices[0]?.message?.content || 'No response received';

        // Calculate mock confidence based on response length and structure
        const confidence = Math.min(0.95, 0.75 + (content.length / 5000) * 0.2);
        confidenceBadge.setAttribute('score', confidence.toFixed(2));
        confidenceBadge.setAttribute('show-percentage', '');

        // Format the response
        const formattedContent = formatAiResponse(content);

        output.innerHTML = `
          <div class="ai-output-header">
            <span class="ai-output-title">${getIntentTitle(intent)}</span>
            <ai-confidence-badge score="${confidence.toFixed(2)}" show-percentage size="sm"></ai-confidence-badge>
          </div>
          <div class="ai-output-content">${formattedContent}</div>
        `;

      } catch (error) {
        output.innerHTML = `
          <div class="ai-output-content" style="color: var(--danger);">
            <strong>Error:</strong> ${error.message}
            <br><br>
            <small>Check your API key and try again.</small>
          </div>
        `;
      }

      // Re-enable buttons
      buttons.forEach(btn => btn.disabled = false);
    };

    function getIntentTitle(intent) {
      const titles = {
        explain: 'Trend Analysis',
        forecast: 'Growth Forecast',
        optimize: 'Optimization Recommendations',
        risks: 'Risk Assessment'
      };
      return titles[intent] || 'AI Analysis';
    }

    function formatAiResponse(content) {
      // Convert markdown-style formatting to HTML
      return content
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\n\n/g, '</p><p>')
        .replace(/\n- /g, '</li><li>')
        .replace(/^- /gm, '<li>')
        .replace(/<li>/g, '</p><ul><li>')
        .replace(/<\/li>(?!<li>)/g, '</li></ul><p>')
        .replace(/^/, '<p>')
        .replace(/$/, '</p>')
        .replace(/<p><\/p>/g, '')
        .replace(/<ul><\/ul>/g, '');
    }
  </script>
</body>
</html>
